#!/bin/sh

set -e

web_env() {
  source $(brew --prefix nvm)/nvm.sh
  cd ${HOME}/code/versal.com
  nvm use 0.10
  ulimit -n 4096
}

if [ -z "${1}" ]; then
  time web all
  web sync
elif [ "${1}" = "all" ]; then
  web_env
  time grunt
  web sync
elif [ "${1}" = "build" ]; then
  web_env
  if [ -z "${2}" ]; then
    time grunt build
  elif [ "${2}" = "client" ]; then
    time grunt clientBuild
  elif [ "${2}" = "server" ]; then
    time grunt build
  fi
  web sync
elif [ "${1}" = "test" ]; then
  web_env
  if [ -z "${2}" ]; then
    time grunt clientTest && grunt serverTest
  elif [ "${2}" = "client" ]; then
    time grunt clientTest
  elif [ "${2}" = "server" ]; then
    time grunt serverTest
  fi
  web sync
elif [ "${1}" = "ctest" ]; then
  web_env
  time grunt clientTest
  web sync
elif [ "${1}" = "stest" ]; then
  web_env
  time grunt serverTest
  web sync
elif [ "${1}" = "fast" ]; then
  web_env
  time grunt stylus coffee:cgm requirejs:cgm
  web sync
elif [ "${1}" = "styles" ]; then
  web_env
  time grunt stylus
  web sync
elif [ "${1}" = "styleguide" ]; then
  web_env
  time grunt buildCSSDocs
  web sync
elif [ "${1}" = "sync" ]; then
  web_env
  time vagrant rsync
elif [ "${1}" = "restart" ]; then
  web_env
  ./dev/tasks.sh restart
elif [ "${1}" = "release" ]; then
  web_env
  ./release.sh
elif [ "${1}" = "log" ]; then
	vagrant ssh -- "cd versal.com && forever stopall ; node app | bunyan -c 'this.name!=\"datapipes\"'"
else
  echo "Usage: web [all|build|test|test|test client|test server|fast|styles|styleguide|sync|restart|release|log]"
  exit 1
fi
